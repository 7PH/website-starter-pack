# ⚠️ STARTERPACK CORE — DO NOT MODIFY. This file is managed by the starterpack.
x-traefik-common: &traefik-common
    container_name: ${COMPOSE_PROJECT_NAME}-traefik
    image: traefik:v2.9
    command:
        - "--log.level=DEBUG"
        - "--api.insecure=true"
        - "--entrypoints.default.address=:${PUBLIC_PORT}"
        - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
        - "--certificatesresolvers.letsencrypt.acme.email=${ADMIN_EMAIL}"
        - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
        - "--providers.file.directory=/configuration/"
        - "--providers.file.watch=true"
    volumes:
        - "/var/run/docker.sock:/var/run/docker.sock:ro"
        - ./services/traefik/dynamic.core.yml:/configuration/dynamic.core.yml:ro
        - ./services/traefik/dynamic.yml:/configuration/dynamic.yml:ro
        - "letsencrypt_traefik:/letsencrypt:rw"
    networks:
        - web
    env_file:
        - .env

x-frontend-common: &frontend-common
    volumes:
        - ./app/frontend/app.vue:/app/app.vue:ro
        - ./app/frontend/_core:/app/_core:ro
        - ./app/frontend/assets:/app/assets:ro
        - ./app/frontend/components:/app/components:ro
        - ./app/frontend/composables:/app/composables:ro
        - ./app/frontend/config:/app/config:ro
        - ./app/frontend/layouts:/app/layouts:ro
        - ./app/frontend/locales:/app/locales:ro
        - ./app/frontend/middleware:/app/middleware:ro
        - ./app/frontend/pages:/app/pages:ro
        - ./app/frontend/plugins:/app/plugins:ro
        - ./app/frontend/stores:/app/stores:ro
        - ./app/frontend/public:/app/public:ro
        - ./app/frontend/types:/app/types:ro
    environment:
        NUXT_PUBLIC_APP_NAME: ${APP_NAME}
        NUXT_PUBLIC_API_BASE: /api
    networks:
        - web

x-backend-common: &backend-common
  container_name: ${COMPOSE_PROJECT_NAME}-backend
  build:
    context: ./app/backend
    dockerfile: Dockerfile
    args:
      - DOCKER_USER=${DOCKER_USER}
      - DOCKER_UID=${DOCKER_UID}
      - DOCKER_GID=${DOCKER_GID}
  env_file: .env
  volumes:
    - ./app/backend/src:/app/src
    - ./app/backend/ruff.toml:/app/ruff.toml:ro
    - ./static:/app/static:rw
  networks:
    web:
      aliases:
        - backend

services:
    # Traefik reverse proxy (dev)
    traefik-dev:
        <<: *traefik-common
        ports:
            - "${PUBLIC_PORT}:${PUBLIC_PORT}"
            - "8080:8080"
        profiles:
            - dev
            - debug
        environment:
            MODE: DEVELOPMENT

    # Traefik reverse proxy (prod)
    traefik-prod:
        <<: *traefik-common
        ports:
            - "${PUBLIC_PORT}:${PUBLIC_PORT}"
        profiles:
            - prod
        environment:
            MODE: PRODUCTION
        depends_on:
            - frontend-prod-nginx
            - backend-prod
    
    # Static file server
    static:
        container_name: ${COMPOSE_PROJECT_NAME}-static
        image: nginx:1.26-alpine3.20-perl
        volumes:
            - ./static:/usr/share/nginx/html:ro
        networks:
            - web
        profiles:
            - prod
            - dev
            - debug

    # PostgreSQL database
    db:
        container_name: ${COMPOSE_PROJECT_NAME}-db
        image: postgres:15.10-alpine3.20
        environment:
            POSTGRES_DB: ${APP_DB_NAME}
            POSTGRES_USER: ${APP_DB_USER}
            POSTGRES_PASSWORD: ${APP_DB_PASSWORD}
        volumes:
            - ./services/db/data:/var/lib/postgresql/data
            - ./services/db/initdb.sql:/docker-entrypoint-initdb.d/init_db.sql
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${APP_DB_USER} -d ${APP_DB_NAME}"]
            interval: 5s
            timeout: 5s
            retries: 5
        networks:
            - web

    # Adminer database management tool
    adminer:
        container_name: ${COMPOSE_PROJECT_NAME}-adminer
        image: adminer
        restart: always
        profiles:
            - prod
            - dev
            - debug
        networks:
            - web
        depends_on:
            - db

    # Backend for Development
    backend-dev:
        <<: *backend-common
        command: ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "80", "--reload", "--root-path", "/api"]
        environment:
            MODE: DEVELOPMENT
        ports:
            - "8082:80"
            - "5679:5679"
        profiles:
            - dev
        depends_on:
            db:
                condition: service_healthy

    # Backend for Debugging
    backend-debug:
        <<: *backend-common
        entrypoint: python3 -m debugpy --log-to-stderr --listen 0.0.0.0:5679 --wait-for-client -m
        command: ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "80", "--reload", "--root-path", "/api"]
        environment:
            MODE: DEVELOPMENT
        ports:
            - "8082:80"
            - "5679:5679"
        profiles:
            - debug
        depends_on:
            db:
                condition: service_healthy

    # Backend for Production
    backend-prod:
        <<: *backend-common
        command: ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "80", "--root-path", "/api"]
        environment:
            MODE: PRODUCTION
        profiles:
            - prod
        depends_on:
            db:
                condition: service_healthy

    # Frontend for development (Nuxt)
    frontend-dev:
        <<: *frontend-common
        container_name: ${COMPOSE_PROJECT_NAME}-frontend
        build:
            context: ./app/frontend
            dockerfile: Dockerfile.dev
            args:
                - DOCKER_USER=${DOCKER_USER}
                - DOCKER_UID=${DOCKER_UID}
                - DOCKER_GID=${DOCKER_GID}
        networks:
            web:
                aliases:
                    - frontend
        profiles:
            - dev
            - debug

    # Frontend for production (Nuxt)
    frontend-prod-node:
        <<: *frontend-common
        container_name: ${COMPOSE_PROJECT_NAME}-frontend-node
        build:
            context: ./app/frontend
            dockerfile: Dockerfile.prod-node
        networks:
            web:
                aliases:
                    - frontend-node
        profiles:
            - prod
        depends_on:
            - backend-prod

    frontend-prod-nginx:
        container_name: ${COMPOSE_PROJECT_NAME}-frontend
        build:
            context: ./app/frontend
            dockerfile: Dockerfile.prod-nginx
        profiles:
            - prod
        depends_on:
            - frontend-prod-node
        networks:
            web:
                aliases:
                    - frontend

    # Umami Analytics
    umami:
        container_name: ${COMPOSE_PROJECT_NAME}-umami
        image: ghcr.io/umami-software/umami:postgresql-latest
        restart: always
        profiles:
            - prod
            - dev
            - debug
        environment:
            DATABASE_URL: postgresql://${UMAMI_DB_USER:-umami}:${UMAMI_DB_PASSWORD:-umami}@umami-db:5432/${UMAMI_DB_NAME:-umami}
            DATABASE_TYPE: postgresql
            APP_SECRET: ${UMAMI_APP_SECRET:-change-me-in-production}
            TRACKER_SCRIPT_NAME: analytics
            DISABLE_TELEMETRY: "1"
        depends_on:
            umami-db:
                condition: service_healthy
        networks:
            web:
                aliases:
                    - umami

    umami-db:
        container_name: ${COMPOSE_PROJECT_NAME}-umami-db
        image: postgres:15-alpine
        restart: always
        profiles:
            - prod
            - dev
            - debug
        environment:
            POSTGRES_DB: ${UMAMI_DB_NAME:-umami}
            POSTGRES_USER: ${UMAMI_DB_USER:-umami}
            POSTGRES_PASSWORD: ${UMAMI_DB_PASSWORD:-umami}
        volumes:
            - ./services/umami/data:/var/lib/postgresql/data:rw
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${UMAMI_DB_USER:-umami} -d ${UMAMI_DB_NAME:-umami}"]
            interval: 5s
            timeout: 5s
            retries: 5
        networks:
            - web

volumes:
    letsencrypt_traefik:

networks:
    web:
        external: false
